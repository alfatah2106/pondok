<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pondok</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        .nav-item.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Mobile Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex">

    <!-- LOGIN OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 z-[60] bg-white/95 backdrop-blur-sm flex flex-col items-center justify-center p-6 transition-all duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl border border-gray-100 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-8 h-8"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-900 mb-1">Monitoring Pondok</h1>
            <p class="text-gray-500 text-sm mb-6">Silakan login dengan akun Ustadz</p>
            <div id="google-btn-container" class="flex justify-center"></div>
        </div>
    </div>

    <!-- MOBILE SIDEBAR BACKDROP -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 z-30 bg-black/50 hidden md:hidden transition-opacity"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-200 transform -translate-x-full md:translate-x-0 sidebar-transition md:relative md:flex flex-col h-full shadow-xl md:shadow-none">
        <div class="p-5 border-b border-gray-100 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 cursor-pointer" onclick="nav('home')">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </div>
                <div>
                    <h2 class="font-bold text-gray-900 text-sm">Dashboard</h2>
                    <p class="text-[10px] text-gray-500">Sistem Monitoring</p>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-red-500">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div class="p-4 bg-gray-50 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="" class="w-9 h-9 rounded-full border border-white shadow-sm bg-gray-200 object-cover">
                <div class="overflow-hidden">
                    <p id="user-name" class="font-semibold text-xs text-gray-900 truncate">Memuat...</p>
                    <p id="user-jabatan" class="text-[10px] text-blue-600 font-medium uppercase tracking-wider">...</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-3 space-y-1">
            <button onclick="nav('home')" id="nav-home" class="nav-item active w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="home" class="w-4 h-4"></i> Home
            </button>
            <button onclick="nav('absensi')" id="nav-absensi" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="user-check" class="w-4 h-4"></i> Absensi
            </button>
            <button onclick="nav('konseling')" id="nav-konseling" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="heart-handshake" class="w-4 h-4"></i> Konseling
            </button>
            
            <!-- ACCESS RESTRICTED: PENGAWAS ONLY -->
            <button onclick="nav('pengawasan')" id="nav-pengawasan" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors hidden">
                <i data-lucide="eye" class="w-4 h-4"></i> Pengawasan
            </button>

            <button onclick="nav('daur')" id="nav-daur" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="clipboard-list" class="w-4 h-4"></i> Laporan Daur
            </button>
            <button onclick="nav('terlambat')" id="nav-terlambat" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="clock" class="w-4 h-4"></i> Keterlambatan
            </button>
            <button onclick="nav('pelanggaran')" id="nav-pelanggaran" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 transition-colors">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i> Pelanggaran
            </button>
        </nav>
        
        <div class="p-4 border-t border-gray-100">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 p-2 text-xs font-bold text-gray-500 hover:text-red-600 transition-colors">
                <i data-lucide="log-out" class="w-3 h-3"></i> KELUAR
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto bg-gray-50 relative w-full">
        <!-- Header Mobile -->
        <header class="bg-white h-16 border-b border-gray-200 flex items-center px-4 justify-between sticky top-0 z-20 md:hidden shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <span class="font-bold text-gray-900 text-lg" id="mobile-title">Home</span>
            </div>
            <div id="status-badge" class="hidden text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded-full">Proses...</div>
        </header>

        <div class="max-w-4xl mx-auto p-4 md:p-8 pb-24">
            
            <!-- 0. HOME (DASHBOARD AWAL) -->
            <section id="tab-home" class="tab-content active space-y-6">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 rounded-2xl shadow-lg text-white mb-6">
                    <h2 class="text-2xl font-bold mb-2">Ahlan wa Sahlan,</h2>
                    <h3 class="text-xl font-medium opacity-90" id="home-user-name">Ustadz</h3>
                    <div class="flex gap-2 mt-4">
                        <span class="text-xs bg-white/20 px-3 py-1 rounded-full" id="home-jabatan">...</span>
                        <span class="text-xs bg-white/20 px-3 py-1 rounded-full" id="home-syuqoh">...</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div onclick="nav('absensi')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col items-center text-center">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600 mb-3"><i data-lucide="user-check" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700">Absensi</span>
                    </div>
                    <div onclick="nav('konseling')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col items-center text-center">
                        <div class="bg-pink-100 p-3 rounded-full text-pink-600 mb-3"><i data-lucide="heart-handshake" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700">Konseling</span>
                    </div>
                    
                    <!-- ACCESS RESTRICTED: PENGAWAS ONLY -->
                    <div onclick="nav('pengawasan')" id="card-pengawasan" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col items-center text-center hidden">
                        <div class="bg-purple-100 p-3 rounded-full text-purple-600 mb-3"><i data-lucide="eye" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700">Pengawasan</span>
                    </div>

                    <div onclick="nav('daur')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col items-center text-center">
                        <div class="bg-emerald-100 p-3 rounded-full text-emerald-600 mb-3"><i data-lucide="clipboard-list" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700">Laporan Daur</span>
                    </div>
                    <div onclick="nav('terlambat')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col items-center text-center">
                        <div class="bg-orange-100 p-3 rounded-full text-orange-600 mb-3"><i data-lucide="clock" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700">Keterlambatan</span>
                    </div>
                    <div onclick="nav('pelanggaran')" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col items-center text-center">
                        <div class="bg-red-100 p-3 rounded-full text-red-600 mb-3"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
                        <span class="font-bold text-gray-700">Pelanggaran</span>
                    </div>
                </div>
            </section>

            <!-- 1. ABSENSI -->
            <section id="tab-absensi" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4"></i> Absensi Kehadiran</h3>
                    
                    <label class="label-text">Keterangan</label>
                    <select id="abs-ket" class="input-field mb-4"><option value="">Loading...</option></select>

                    <div class="cam-container relative">
                        <video id="vid-abs" class="w-full h-full object-cover hidden scale-x-[-1]"></video>
                        <img id="img-abs" class="w-full h-full object-cover hidden rounded-lg scale-x-[-1]">
                        <div id="cam-placeholder-abs" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                            <i data-lucide="camera" class="w-8 h-8 mb-2"></i>
                            <span class="text-xs">Preview Kamera</span>
                        </div>
                        <!-- CAM SWITCH BTN -->
                        <button onclick="toggleCam('vid-abs')" id="btn-switch-abs" class="absolute top-2 right-2 bg-white/80 p-2 rounded-full shadow hidden z-10 text-gray-700">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="startCam('vid-abs', 'cam-placeholder-abs', 'btn-switch-abs')" class="btn-secondary">Buka Kamera</button>
                        <button onclick="takeSnap('vid-abs', 'img-abs')" class="btn-primary bg-gray-800 hover:bg-gray-900">Ambil Foto</button>
                    </div>

                    <button onclick="submitAbsensi()" class="btn-primary w-full">Simpan Absensi</button>
                </div>
            </section>

            <!-- 2. KONSELING -->
            <section id="tab-konseling" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="heart-handshake" class="w-4 h-4"></i> Form Konseling</h3>
                    <p class="text-xs text-gray-400 mb-4">Filter otomatis berdasarkan Syuqoh Anda</p>

                    <label class="label-text">Pilih Kamar</label>
                    <select id="kon-kamar" onchange="filterKonSantri()" class="input-field mb-3"></select>

                    <label class="label-text">Pilih Santri</label>
                    <select id="kon-santri" class="input-field mb-3 disabled:bg-gray-100" disabled>
                        <option value="">Pilih Kamar dulu</option>
                    </select>

                    <label class="label-text">Laporan Konseling</label>
                    <textarea id="kon-laporan" rows="4" class="input-field mb-4" placeholder="Tulis detail konseling..."></textarea>

                    <button onclick="submitKonseling()" class="btn-primary w-full">Simpan Laporan</button>
                </div>
            </section>

            <!-- 3. PENGAWASAN -->
            <section id="tab-pengawasan" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="eye" class="w-4 h-4"></i> Pengawasan Daur</h3>
                    <p class="text-xs text-gray-400 mb-4">List Musyrif di Gedung Anda</p>

                    <label class="label-text">Pilih Daur</label>
                    <select id="peng-daur" class="input-field mb-4"></select>

                    <div id="list-musyrif" class="space-y-3 mb-4 max-h-96 overflow-y-auto no-scrollbar">
                        <div class="text-center text-xs text-gray-400 py-4">Memuat data musyrif...</div>
                    </div>

                    <button onclick="submitPengawasan()" class="btn-primary w-full">Simpan Pengawasan</button>
                </div>
            </section>

            <!-- 4. DAUR -->
            <section id="tab-daur" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-1 flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4"></i> Checklist Daur Santri</h3>
                    <p class="text-xs text-gray-400 mb-4">Santri di Syuqoh Anda (Urut Kamar)</p>
                    
                    <div id="list-daur-santri" class="space-y-2 mb-4 max-h-80 overflow-y-auto border rounded-lg p-2 bg-gray-50"></div>
                    
                    <div id="daur-bulk-area" class="hidden border-t pt-4">
                        <p class="text-xs font-bold mb-2 text-blue-600">Santri Terpilih (<span id="daur-count">0</span>):</p>
                        <div id="daur-selected-list" class="flex flex-wrap gap-1 mb-3"></div>
                        <label class="label-text">Keterangan (untuk semua terpilih)</label>
                        <select id="daur-ket-bulk" class="input-field mb-4"></select>
                        <button onclick="submitDaur()" class="btn-primary w-full">Simpan Laporan Daur</button>
                    </div>
                </div>
            </section>

            <!-- 5. KETERLAMBATAN -->
            <section id="tab-terlambat" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> Input Keterlambatan</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="label-text">Jenis</label><select id="telat-jenis" class="input-field"></select></div>
                        <div>
                            <label class="label-text">Gedung</label>
                            <select id="telat-gedung" class="input-field" onchange="clearSearch()">
                                <option value="">--Pilih--</option><option value="A">Gedung A</option><option value="B">Gedung B</option><option value="C">Gedung C</option>
                            </select>
                        </div>
                    </div>
                    <div class="relative mb-4">
                        <input type="text" id="telat-search" onkeyup="searchSantri('telat')" placeholder="Cari Nama Santri..." class="input-field pl-9">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-3.5"></i>
                        <div id="telat-results" class="absolute z-10 w-full bg-white shadow-xl rounded-lg mt-1 max-h-48 overflow-y-auto hidden border"></div>
                    </div>
                    <div id="telat-cart" class="space-y-2 mb-4"></div>
                    <button onclick="submitTerlambat()" class="btn-primary w-full bg-orange-600 hover:bg-orange-700">Simpan Data</button>
                </div>
            </section>

            <!-- 6. PELANGGARAN -->
            <section id="tab-pelanggaran" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm border-l-4 border-l-red-500">
                    <h3 class="font-bold text-red-700 mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Catat Pelanggaran</h3>
                    <label class="label-text">Jenis Pelanggaran</label>
                    <select id="pel-ket" class="input-field mb-4"></select>
                    <div class="relative mb-4">
                        <input type="text" id="pel-search" onkeyup="searchSantri('pel')" placeholder="Cari Nama Santri (Semua Gedung)..." class="input-field pl-9">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-3.5"></i>
                        <div id="pel-results" class="absolute z-10 w-full bg-white shadow-xl rounded-lg mt-1 max-h-48 overflow-y-auto hidden border"></div>
                    </div>
                    <div id="pel-cart" class="space-y-2 mb-4"></div>
                    
                    <div class="cam-container h-48 mb-2 relative">
                        <video id="vid-pel" class="w-full h-full object-cover hidden"></video>
                        <img id="img-pel" class="w-full h-full object-cover hidden rounded-lg">
                        <div id="cam-placeholder-pel" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                            <i data-lucide="camera" class="w-8 h-8 mb-2"></i><span class="text-xs">Foto Bukti (Wajib)</span>
                        </div>
                         <!-- CAM SWITCH BTN (No Default Front for Violation, usually back) -->
                        <button onclick="toggleCam('vid-pel')" id="btn-switch-pel" class="absolute top-2 right-2 bg-white/80 p-2 rounded-full shadow hidden z-10 text-gray-700">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <button onclick="startCam('vid-pel', 'cam-placeholder-pel', 'btn-switch-pel', false)" class="btn-secondary py-1 text-xs">Buka Kamera</button>
                        <button onclick="takeSnap('vid-pel', 'img-pel')" class="btn-secondary py-1 text-xs bg-red-100 text-red-700 border-red-200">Ambil Foto</button>
                    </div>

                    <button onclick="submitPelanggaran()" class="btn-primary w-full bg-red-600 hover:bg-red-700">Simpan Pelanggaran</button>
                </div>
            </section>

        </div>
    </main>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg text-sm transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50">
        <i id="toast-icon" data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toast-msg">Notifikasi</span>
    </div>

    <style>
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.875rem; background-color: #fff; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #3b82f6; ring: 2px solid #3b82f6; }
        .label-text { display: block; font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 0.25rem; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; padding: 0.75rem; border-radius: 0.5rem; transition: background 0.2s; font-size: 0.875rem; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #f3f4f6; color: #374151; font-weight: 600; padding: 0.75rem; border-radius: 0.5rem; width: 100%; border: 1px solid #e5e7eb; font-size: 0.875rem; }
        .cam-container { position: relative; background-color: #f9fafb; border: 2px dashed #d1d5db; border-radius: 0.75rem; overflow: hidden; aspect-ratio: 16/9; margin-bottom: 0.5rem; }
    </style>

    <script>
        // --- KONFIGURASI (GANTI URL WEB APP ANDA DI SINI) ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyZUCDpFskmp3JtrjYUcHDGdJ9SsZ_V6XhxXWVcEhREMU1K3zl8heM8eWu4gZWtBiiqaw/exec";
        const CLIENT_ID = "142276774829-q7b6vicbq1hm1ltng7itehietn03l119.apps.googleusercontent.com";
        
        let state = {
            user: null,
            dropdowns: {},
            santriCache: [],
            cart: { telat: [], pel: [], daur: [] },
            camMode: 'user', // Default FRONT
            stream: null
        };

        window.onload = () => {
            initAuth();
            lucide.createIcons();
            const savedUser = localStorage.getItem('pondok_user_session');
            if (savedUser) {
                try {
                    const parsed = JSON.parse(savedUser);
                    if (parsed.email) {
                        state.user = parsed;
                        document.getElementById('auth-overlay').classList.add('hidden');
                        updateUIUser();
                        loadInitialData();
                        checkAccessLevel(); // Cek Jabatan
                        showToast('success', 'Selamat datang kembali!');
                    }
                } catch (e) { localStorage.removeItem('pondok_user_session'); }
            }
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full'); backdrop.classList.add('hidden');
            }
        }

        function initAuth() {
            google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleLogin });
            google.accounts.id.renderButton(document.getElementById("google-btn-container"), { theme: "outline", size: "large" });
        }

        async function handleLogin(res) {
            showToast('loading', 'Sedang masuk...');
            const payload = JSON.parse(atob(res.credential.split('.')[1]));
            try {
                const apiRes = await fetch(`${API_URL}?action=get_profile&email=${payload.email}&picture=${encodeURIComponent(payload.picture)}`);
                const profile = await apiRes.json();
                if (profile.status === 'success') {
                    state.user = { ...payload, ...profile, picture: payload.picture };
                    localStorage.setItem('pondok_user_session', JSON.stringify(state.user));
                    document.getElementById('auth-overlay').classList.add('hidden');
                    updateUIUser();
                    loadInitialData();
                    checkAccessLevel(); // Cek Jabatan
                } else { showToast('error', 'Email tidak terdaftar'); }
            } catch (e) { showToast('error', 'Gagal koneksi server'); }
        }

        function logout() { localStorage.removeItem('pondok_user_session'); location.reload(); }

        function updateUIUser() {
            document.getElementById('user-name').innerText = state.user.nama;
            document.getElementById('user-jabatan').innerText = state.user.jabatan;
            document.getElementById('user-photo').src = state.user.picture;
            document.getElementById('home-user-name').innerText = state.user.nama;
            document.getElementById('home-syuqoh').innerText = `${state.user.gedung} - ${state.user.syuqoh}`;
            document.getElementById('home-jabatan').innerText = state.user.jabatan;
        }

        // --- CEK JABATAN (PENGAWASAN) ---
        function checkAccessLevel() {
            const isPengawas = (state.user.jabatan || "").toUpperCase().trim() === 'PENGAWAS';
            const navBtn = document.getElementById('nav-pengawasan');
            const cardBtn = document.getElementById('card-pengawasan');
            
            if (isPengawas) {
                navBtn.classList.remove('hidden');
                cardBtn.classList.remove('hidden');
            } else {
                navBtn.classList.add('hidden');
                cardBtn.classList.add('hidden');
            }
        }

        async function loadInitialData() {
            try {
                const res = await fetch(`${API_URL}?action=get_initial_data`);
                state.dropdowns = await res.json();
                populateSelect('abs-ket', state.dropdowns.keterangan);
                populateSelect('peng-daur', state.dropdowns.daur);
                populateSelect('telat-jenis', state.dropdowns.jenis_keterlambatan);
                populateSelect('pel-ket', state.dropdowns.pelanggaran);
                populateSelect('daur-ket-bulk', state.dropdowns.keterangan);
                populateSelect('telat-gedung', state.dropdowns.gedung);
                const resSantri = await fetch(`${API_URL}?action=get_santri_by_syuqoh&syuqoh=${state.user.syuqoh}`);
                state.santriCache = await resSantri.json();
                initKonseling(); initDaur(); initPengawasan();
            } catch (e) { console.error(e); }
        }

        async function submitAbsensi() {
            const ket = val('abs-ket'); const foto = getImgSrc('img-abs');
            if(!ket || !foto) return showToast('error', 'Isi keterangan & foto');
            setLoading(true); const loc = await getLoc();
            postData('save_absensi', { email: state.user.email, nama: state.user.nama, keterangan: ket, foto: foto, lokasi: loc }, () => {
                val('abs-ket', ''); resetCam('img-abs', 'vid-abs', 'cam-placeholder-abs', 'btn-switch-abs');
            });
        }

        function initKonseling() {
            const kamars = [...new Set(state.santriCache.map(s => s.kamar))].sort();
            populateSelect('kon-kamar', kamars);
        }
        function filterKonSantri() {
            const kamar = val('kon-kamar'); const santriEl = document.getElementById('kon-santri');
            santriEl.innerHTML = '<option value="">Pilih Santri</option>';
            state.santriCache.filter(s => s.kamar == kamar).forEach(s => santriEl.add(new Option(`${s.nama} (${s.nisn})`, s.nisn)));
            santriEl.disabled = false;
        }
        function submitKonseling() {
            const nisn = val('kon-santri'); const kamar = val('kon-kamar'); const lap = val('kon-laporan');
            if(!nisn || !lap) return showToast('error', 'Lengkapi data');
            const santri = state.santriCache.find(s => s.nisn == nisn);
            postData('save_konseling', { email: state.user.email, nama: state.user.nama, syuqoh: state.user.syuqoh, kamar_santri: kamar, nisn: nisn, nama_santri: santri.nama, laporan: lap }, () => {
                val('kon-laporan', ''); val('kon-kamar', ''); filterKonSantri();
            });
        }

        async function initPengawasan() {
            const container = document.getElementById('list-musyrif');
            // Hanya akses jika jabatan Pengawas, tapi load saja untuk safety
            try {
                const res = await fetch(`${API_URL}?action=get_musyrif_by_gedung&gedung=${state.user.gedung}`);
                const musyrifs = await res.json();
                container.innerHTML = musyrifs.map(m => `
                    <div class="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                        <span class="text-sm font-semibold">${m.nama}</span>
                        <select class="musyrif-input text-xs p-1 border rounded" data-id="${m.id}" data-nama="${m.nama}">
                             <option value="">-Status-</option>${state.dropdowns.keterangan.map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>`).join('');
            } catch(e) { container.innerHTML = 'Gagal memuat musyrif'; }
        }
        function submitPengawasan() {
            const daur = val('peng-daur'); const inputs = document.querySelectorAll('.musyrif-input'); let rows = [];
            inputs.forEach(inp => { if(inp.value) rows.push({ id_musyrif: inp.dataset.id, nama_musyrif: inp.dataset.nama, keterangan: inp.value }); });
            if(!daur || rows.length === 0) return showToast('error', 'Pilih Daur & min. 1 Musyrif');
            postData('save_pengawasan', { email: state.user.email, nama: state.user.nama, gedung: state.user.gedung, daur: daur, rows: rows }, () => {
                val('peng-daur', ''); inputs.forEach(i => i.value = '');
            });
        }

        function initDaur() {
            const container = document.getElementById('list-daur-santri');
            const sorted = state.santriCache.sort((a,b) => a.kamar - b.kamar);
            container.innerHTML = sorted.map(s => `
                <label class="flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer">
                    <input type="checkbox" class="daur-chk w-4 h-4 text-blue-600 rounded" value="${s.nisn}" data-nama="${s.nama}" data-kamar="${s.kamar}" onchange="updateDaurUI()">
                    <div><div class="text-sm font-bold text-gray-700">${s.nama}</div><div class="text-[10px] text-gray-500 uppercase">Kamar ${s.kamar}</div></div>
                </label>`).join('');
        }
        function updateDaurUI() {
            const checked = document.querySelectorAll('.daur-chk:checked');
            const area = document.getElementById('daur-bulk-area');
            const list = document.getElementById('daur-selected-list');
            document.getElementById('daur-count').innerText = checked.length;
            if(checked.length > 0) {
                area.classList.remove('hidden');
                list.innerHTML = Array.from(checked).map(c => `<span class="text-[10px] bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${c.dataset.nama.split(' ')[0]}</span>`).join('');
            } else { area.classList.add('hidden'); }
        }
        function submitDaur() {
            const ket = val('daur-ket-bulk'); const checked = document.querySelectorAll('.daur-chk:checked');
            if(!ket || checked.length === 0) return showToast('error', 'Pilih santri & keterangan');
            let rows = Array.from(checked).map(c => ({ nisn: c.value, nama_santri: c.dataset.nama, kamar: c.dataset.kamar, keterangan: ket }));
            postData('save_daur', { email: state.user.email, nama: state.user.nama, syuqoh: state.user.syuqoh, rows: rows }, () => {
                document.querySelectorAll('.daur-chk').forEach(c => c.checked = false); updateDaurUI();
            });
        }

        let searchTimeout;
        async function searchSantri(type) {
            const q = val(`${type}-search`); const box = document.getElementById(`${type}-results`);
            if(q.length < 3) { box.classList.add('hidden'); return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const gedungParam = type === 'telat' ? `&gedung=${val('telat-gedung')}` : '';
                if(type === 'telat' && !val('telat-gedung')) return showToast('error', 'Pilih gedung dulu');
                try {
                    const res = await fetch(`${API_URL}?action=search_santri&q=${q}${gedungParam}`);
                    const data = await res.json();
                    box.classList.remove('hidden');
                    box.innerHTML = data.map(s => `
                        <div onclick="addToCart('${type}', '${s.nisn}', '${s.nama}', '${s.gedung}')" class="p-3 border-b hover:bg-gray-50 cursor-pointer flex justify-between items-center">
                            <div><div class="text-sm font-bold">${s.nama}</div><div class="text-xs text-gray-500">${s.nisn} - Gedung ${s.gedung}</div></div>
                            <i data-lucide="plus-circle" class="w-4 h-4 text-blue-600"></i>
                        </div>`).join('');
                    lucide.createIcons();
                } catch(e) {}
            }, 500);
        }
        function addToCart(type, nisn, nama, gedung) {
            if(!state.cart[type].find(x => x.nisn == nisn)) { state.cart[type].push({ nisn, nama, gedung }); renderCart(type); document.getElementById(`${type}-search`).value = ''; document.getElementById(`${type}-results`).classList.add('hidden'); }
        }
        function renderCart(type) {
            const container = document.getElementById(`${type}-cart`);
            container.innerHTML = state.cart[type].map(i => `
                <div class="flex justify-between items-center p-2 bg-gray-100 rounded text-sm"><span>${i.nama}</span><button onclick="removeFromCart('${type}', '${i.nisn}')" class="text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></div>`).join('');
            lucide.createIcons();
        }
        function removeFromCart(type, nisn) { state.cart[type] = state.cart[type].filter(x => x.nisn != nisn); renderCart(type); }
        function submitTerlambat() {
            const jenis = val('telat-jenis'); const gedung = val('telat-gedung');
            if(!jenis || state.cart.telat.length === 0) return showToast('error', 'Data belum lengkap');
            let rows = state.cart.telat.map(s => ({ nisn: s.nisn, nama_santri: s.nama }));
            postData('save_terlambat', { email: state.user.email, nama: state.user.nama, jenis: jenis, gedung: gedung, rows: rows }, () => {
                state.cart.telat = []; renderCart('telat'); val('telat-jenis', '');
            });
        }
        function submitPelanggaran() {
            const ket = val('pel-ket'); const foto = getImgSrc('img-pel');
            if(!ket || !foto || state.cart.pel.length === 0) return showToast('error', 'Lengkapi data + foto');
            let rows = state.cart.pel.map(s => ({ nisn: s.nisn, nama_santri: s.nama, gedung: s.gedung }));
            postData('save_pelanggaran', { email: state.user.email, nama: state.user.nama, keterangan: ket, foto: foto, rows: rows }, () => {
                state.cart.pel = []; renderCart('pel'); val('pel-ket', ''); resetCam('img-pel', 'vid-pel', 'cam-placeholder-pel', 'btn-switch-pel');
            });
        }
        function clearSearch() { state.cart.telat = []; renderCart('telat'); }

        // --- HELPERS ---
        function nav(tab) {
            if (window.innerWidth < 768) { const sidebar = document.getElementById('sidebar'); if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar(); }
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.getElementById('mobile-title').innerText = tab === 'home' ? 'Home' : tab.charAt(0).toUpperCase() + tab.slice(1);
        }
        async function postData(action, payload, callback) {
            setLoading(true); payload.action = action;
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.status === 'success') { showToast('success', 'Data tersimpan!'); if(callback) callback(); } 
                else { showToast('error', json.message || 'Gagal simpan'); }
            } catch(e) { showToast('error', 'Koneksi error'); }
            setLoading(false);
        }
        function val(id, v) { if(v !== undefined) document.getElementById(id).value = v; return document.getElementById(id).value; }
        function populateSelect(id, arr) { const el = document.getElementById(id); if (!el) return; el.innerHTML = `<option value="">--Pilih--</option>`; if(arr) arr.forEach(x => el.add(new Option(x, x))); }
        function setLoading(bool) { const badge = document.getElementById('status-badge'); if(bool) badge.classList.remove('hidden'); else badge.classList.add('hidden'); }
        function showToast(type, msg) {
            const t = document.getElementById('toast'); const i = document.getElementById('toast-icon');
            document.getElementById('toast-msg').innerText = msg;
            i.className = `w-4 h-4 ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
            i.setAttribute('data-lucide', type === 'success' ? 'check-circle' : 'alert-circle');
            lucide.createIcons();
            t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- CAMERA LOGIC UPDATED ---
        function startCam(vidId, placeId, btnSwitchId, defaultFront = true) {
            const vid = document.getElementById(vidId);
            const btn = document.getElementById(btnSwitchId);
            state.camMode = defaultFront ? 'user' : 'environment'; // Set default mode
            
            document.getElementById(placeId).classList.add('hidden');
            if(btn) btn.classList.remove('hidden');
            vid.classList.remove('hidden');
            
            initStream(vid);
        }

        function initStream(vid) {
            if(state.stream) state.stream.getTracks().forEach(t => t.stop());
            
            navigator.mediaDevices.getUserMedia({video: {facingMode: state.camMode}}).then(s => {
                state.stream = s;
                vid.srcObject = s;
                vid.play();
            }).catch(e => showToast('error', 'Kamera error: ' + e));
        }

        function toggleCam(vidId) {
            state.camMode = state.camMode === 'user' ? 'environment' : 'user';
            const vid = document.getElementById(vidId);
            initStream(vid);
        }

        function takeSnap(vidId, imgId) {
            const vid = document.getElementById(vidId);
            const cvs = document.createElement('canvas');
            cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
            const ctx = cvs.getContext('2d');
            
            // Mirror effect fix for front camera
            if (state.camMode === 'user') {
                ctx.translate(cvs.width, 0);
                ctx.scale(-1, 1);
            }
            
            ctx.drawImage(vid, 0, 0);
            const url = cvs.toDataURL('image/jpeg', 0.6);
            document.getElementById(imgId).src = url;
            document.getElementById(imgId).classList.remove('hidden');
            vid.classList.add('hidden');
            if(state.stream) state.stream.getTracks().forEach(t => t.stop());
        }

        function getImgSrc(imgId) { const src = document.getElementById(imgId).src; return src.includes('base64') ? src : null; }
        
        function resetCam(imgId, vidId, placeId, btnSwitchId) {
            document.getElementById(imgId).src = ''; document.getElementById(imgId).classList.add('hidden');
            document.getElementById(vidId).classList.add('hidden'); 
            document.getElementById(placeId).classList.remove('hidden');
            if(btnSwitchId) document.getElementById(btnSwitchId).classList.add('hidden');
        }

        function getLoc() { return new Promise(resolve => { navigator.geolocation.getCurrentPosition(p => resolve(`${p.coords.latitude},${p.coords.longitude}`), () => resolve("Lokasi tidak dizinkan")); }); }
    </script>
</body>
</html>
