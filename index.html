<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pondok - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8">
            <div class="w-20 h-20 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-10 h-10 text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">Monitoring Pondok</h1>
            <p class="text-gray-500 mt-2">Silakan login menggunakan akun Google Ustadz</p>
        </div>
        <div id="google-btn-container"></div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="flex flex-col md:flex-row h-screen overflow-hidden blur-sm pointer-events-none transition-all duration-500">

        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg text-white">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">PondokApp</span>
            </div>

            <div class="p-4 border-b border-gray-50 bg-gray-50/50">
                <div class="flex items-center gap-3">
                    <img id="user-photo" src="" alt="Avatar" class="w-10 h-10 rounded-full border border-blue-200 hidden">
                    <div class="overflow-hidden">
                        <p id="user-name" class="font-bold text-sm truncate">Memuat...</p>
                        <p id="user-role" class="text-xs text-blue-600 font-medium truncate italic uppercase">Ustadz</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="switchTab('absensi', this)" class="nav-btn active w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="user-check" class="w-5 h-5 mr-3"></i> Absensi
                </button>
                <button onclick="switchTab('konseling', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="heart-handshake" class="w-5 h-5 mr-3"></i> Konseling
                </button>
                <button onclick="switchTab('pengawasan', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="shield" class="w-5 h-5 mr-3"></i> Pengawasan
                </button>
                <button onclick="switchTab('daur', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Laporan Daur
                </button>
                <button onclick="switchTab('terlambat', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i> Terlambat
                </button>
                <button onclick="switchTab('pelanggaran', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100 text-red-600 hover:text-red-700">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-3"></i> Pelanggaran
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button onclick="location.reload()" class="w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-red-50 hover:text-red-600 transition-all text-sm font-medium">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Keluar
                </button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-10">
                <h2 id="header-title" class="font-bold text-lg text-gray-900">Absensi Kehadiran</h2>
                <div id="global-status" class="hidden flex items-center gap-2 text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full">
                    <div class="loader"></div> Sinkronisasi...
                </div>
            </header>

            <div class="p-4 md:p-8 max-w-4xl mx-auto">
                <!-- Sesuai dengan isi tab sebelumnya -->
                <section id="tab-absensi" class="tab-content active space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Keterangan Kehadiran</label>
                        <select id="absensi-ket" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Pilih Keterangan --</option>
                        </select>
                        <div class="space-y-4">
                            <div class="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center border-2 border-dashed border-gray-300 relative">
                                <video id="video-absensi" class="hidden w-full h-full object-cover"></video>
                                <img id="photo-preview-absensi" class="hidden w-full h-full object-cover">
                                <div id="cam-placeholder-absensi" class="text-center">
                                    <i data-lucide="camera" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500">Klik "Buka Kamera"</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="startCamera('video-absensi', 'cam-placeholder-absensi')" class="flex-1 bg-gray-800 text-white py-3 rounded-xl text-sm font-bold">Buka Kamera</button>
                                <button onclick="capturePhoto('video-absensi', 'photo-preview-absensi', 'absensi-photo-data')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl text-sm font-bold">Ambil Foto</button>
                            </div>
                            <input type="hidden" id="absensi-photo-data">
                        </div>
                        <button onclick="submitAbsensi()" class="w-full mt-6 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition-all">Simpan & Reset</button>
                    </div>
                </section>

                <!-- Tab lainnya tetap sama strukturnya seperti versi sebelumnya... -->
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-6 right-6 z-[110] space-y-3 pointer-events-none"></div>

    <script>
        // --- KONFIGURASI (WAJIB GANTI URL INI) ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzfuc0dZFhefaM07RVvyPF8yCZpu6piVvznld9urTNUgixqRzGjGuuwXe7OEY2bSRnr5g/exec";
        const CLIENT_ID = "142276774829-q7b6vicbq1hm1ltng7itehietn03l119.apps.googleusercontent.com";

        let currentUser = null;
        let dbDropdown = {};
        let allSantriCache = [];
        let selectedItems = { terlambat: [], pelanggaran: [], daur: [] };

        window.onload = () => {
            initGoogleAuth();
            lucide.createIcons();
            // Cek apakah URL sudah diganti
            if (API_URL === "GANTI_DENGAN_URL_WEB_APP_ANDA") {
                console.error("Kesalahan: API_URL belum dikonfigurasi!");
                alert("Sistem belum siap: API_URL belum diatur di dalam kode.");
            }
        };

        // --- AUTH LOGIC ---
        function initGoogleAuth() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("google-btn-container"),
                { theme: "outline", size: "large", shape: "pill" }
            );
        }

        async function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            showGlobalStatus(true);

            try {
                console.log("Mencoba menghubungi server untuk email:", payload.email);

                // Menambahkan timeout agar tidak menunggu selamanya
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 detik timeout

                const res = await fetch(`${API_URL}?action=get_profile&email=${payload.email}`, { signal: controller.signal });
                clearTimeout(timeoutId);

                const profile = await res.json();
                console.log("Response Profile:", profile);

                if (profile && profile.status !== "error") {
                    currentUser = { ...payload, ...profile };
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('blur-sm', 'pointer-events-none');
                    setupUserUI();
                    loadInitialData();
                } else {
                    alert("Akses Ditolak: Email Anda tidak ditemukan di DB USTADZ atau script mengembalikan error.");
                    console.warn("Profil tidak ditemukan atau status error", profile);
                }
            } catch (e) {
                console.error("Detail Error Koneksi:", e);
                alert("Gagal terhubung ke Server.\n\nPastikan:\n1. URL Web App sudah benar.\n2. Script sudah di-Deploy sebagai 'Anyone'.\n3. Cek Console (F12) untuk detail teknis.");
            } finally {
                showGlobalStatus(false);
            }
        }

        function setupUserUI() {
            document.getElementById('user-name').innerText = currentUser.nama;
            document.getElementById('user-photo').src = currentUser.picture;
            document.getElementById('user-photo').classList.remove('hidden');
            const badge = document.getElementById('syuqoh-badge');
            if (badge) badge.innerText = `Syuqoh: ${currentUser.syuqoh}`;
        }

        async function loadInitialData() {
            showGlobalStatus(true);
            try {
                const resD = await fetch(`${API_URL}?action=get_initial_data`);
                dbDropdown = await resD.json();
                populateDropdowns();

                const resS = await fetch(`${API_URL}?action=get_santri_by_room&syuqoh=${currentUser.syuqoh}`);
                allSantriCache = await resS.json();
            } catch (e) {
                console.error("Gagal memuat data awal:", e);
            } finally {
                showGlobalStatus(false);
            }
        }

        // --- Fungsi pembantu lainnya tetap sama ---
        function populateDropdowns() {
            const populate = (id, arr) => {
                const el = document.getElementById(id);
                if (el && arr) {
                    el.innerHTML = '<option value="">-- Pilih --</option>';
                    arr.forEach(val => el.add(new Option(val, val)));
                }
            };
            populate('absensi-ket', dbDropdown.keterangan || []);
            populate('pengawasan-daur', dbDropdown.daur || []);
            populate('terlambat-jenis', dbDropdown.jenisKeterlambatan || []);
            populate('pelanggaran-ket', dbDropdown.pelanggaran || []);
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            btn.classList.add('active');
            document.getElementById('header-title').innerText = tabId.toUpperCase();
        }

        function showGlobalStatus(show) { document.getElementById('global-status').classList.toggle('hidden', !show); }
    </script>
</body>
</html>
