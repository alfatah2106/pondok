<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pondok - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8">
            <div class="w-20 h-20 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-10 h-10 text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">Monitoring Pondok</h1>
            <p class="text-gray-500 mt-2">Silakan login menggunakan akun Google Ustadz</p>
        </div>
        <div id="google-btn-container"></div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="flex flex-col md:flex-row h-screen overflow-hidden blur-sm pointer-events-none transition-all duration-500">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg text-white">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">PondokApp</span>
            </div>

            <div class="p-4 border-b border-gray-50 bg-gray-50/50">
                <div class="flex items-center gap-3">
                    <img id="user-photo" src="" alt="Avatar" class="w-10 h-10 rounded-full border border-blue-200 hidden">
                    <div class="overflow-hidden">
                        <p id="user-name" class="font-bold text-sm truncate">Memuat...</p>
                        <p id="user-role" class="text-xs text-blue-600 font-medium truncate italic uppercase">Ustadz</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="switchTab('absensi', this)" class="nav-btn active w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="user-check" class="w-5 h-5 mr-3"></i> Absensi
                </button>
                <button onclick="switchTab('konseling', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="heart-handshake" class="w-5 h-5 mr-3"></i> Konseling
                </button>
                <button onclick="switchTab('pengawasan', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="shield" class="w-5 h-5 mr-3"></i> Pengawasan
                </button>
                <button onclick="switchTab('daur', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Laporan Daur
                </button>
                <button onclick="switchTab('terlambat', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i> Terlambat
                </button>
                <button onclick="switchTab('pelanggaran', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100 text-red-600 hover:text-red-700">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-3"></i> Pelanggaran
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button onclick="location.reload()" class="w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-red-50 hover:text-red-600 transition-all text-sm font-medium">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Keluar
                </button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-10">
                <h2 id="header-title" class="font-bold text-lg text-gray-900">Absensi Kehadiran</h2>
                <div id="global-status" class="hidden flex items-center gap-2 text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full">
                    <div class="loader"></div> Sinkronisasi...
                </div>
            </header>

            <div class="p-4 md:p-8 max-w-4xl mx-auto">
                
                <!-- Tab Absensi -->
                <section id="tab-absensi" class="tab-content active space-y-6">
                    <div id="form-absensi" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Keterangan Kehadiran</label>
                        <select id="absensi-ket" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Menunggu Data --</option>
                        </select>
                        
                        <div class="space-y-4">
                            <div class="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center border-2 border-dashed border-gray-300 relative">
                                <video id="video-absensi" class="hidden w-full h-full object-cover"></video>
                                <img id="photo-preview-absensi" class="hidden w-full h-full object-cover">
                                <div id="cam-placeholder-absensi" class="text-center">
                                    <i data-lucide="camera" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500">Klik "Buka Kamera"</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button id="btn-open-cam" onclick="startCamera('video-absensi', 'cam-placeholder-absensi')" class="flex-1 bg-gray-800 text-white py-3 rounded-xl text-sm font-bold active:scale-95 transition-all">Buka Kamera</button>
                                <button id="btn-capture" onclick="capturePhoto('video-absensi', 'photo-preview-absensi', 'absensi-photo-data')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl text-sm font-bold active:scale-95 transition-all">Ambil Foto</button>
                            </div>
                            <input type="hidden" id="absensi-photo-data">
                        </div>
                        
                        <button id="btn-submit-absensi" onclick="submitAbsensi()" class="w-full mt-6 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition-all disabled:bg-gray-300 disabled:shadow-none">Simpan & Reset</button>
                    </div>
                </section>

                <section id="tab-konseling" class="tab-content p-10 text-center text-gray-400">Fitur Konseling segera hadir.</section>
                <section id="tab-pengawasan" class="tab-content p-10 text-center text-gray-400">Fitur Pengawasan segera hadir.</section>
                <section id="tab-daur" class="tab-content p-10 text-center text-gray-400">Fitur Laporan Daur segera hadir.</section>
                <section id="tab-terlambat" class="tab-content p-10 text-center text-gray-400">Fitur Terlambat segera hadir.</section>
                <section id="tab-pelanggaran" class="tab-content p-10 text-center text-gray-400 text-red-300">Fitur Pelanggaran segera hadir.</section>
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-6 right-6 z-[110] space-y-3 pointer-events-none"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzfuc0dZFhefaM07RVvyPF8yCZpu6piVvznld9urTNUgixqRzGjGuuwXe7OEY2bSRnr5g/exec"; 
        const CLIENT_ID = "142276774829-q7b6vicbq1hm1ltng7itehietn03l119.apps.googleusercontent.com";

        let currentUser = null;
        let dbDropdown = {};

        window.onload = () => {
            initGoogleAuth();
            lucide.createIcons();
        };

        function initGoogleAuth() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("google-btn-container"),
                { theme: "outline", size: "large", shape: "pill" }
            );
        }

        async function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            showGlobalStatus(true);
            
            try {
                const res = await fetch(`${API_URL}?action=get_profile&email=${payload.email}`);
                if (!res.ok) throw new Error('Koneksi Gagal');
                const profile = await res.json();
                
                if (profile && profile.status !== "error") {
                    currentUser = { ...payload, ...profile };
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('blur-sm', 'pointer-events-none');
                    setupUserUI();
                    loadInitialData();
                } else {
                    alert("Akses Ditolak: Profil tidak terdaftar.");
                }
            } catch (e) {
                alert("Gagal Login. Pastikan Script dideploy 'Anyone'.");
            } finally {
                showGlobalStatus(false);
            }
        }

        function setupUserUI() {
            document.getElementById('user-name').innerText = currentUser.nama;
            document.getElementById('user-photo').src = currentUser.picture;
            document.getElementById('user-photo').classList.remove('hidden');
        }

        async function loadInitialData() {
            showGlobalStatus(true);
            try {
                const res = await fetch(`${API_URL}?action=get_initial_data`);
                dbDropdown = await res.json();
                populateDropdowns();
            } catch (e) {
                showNotify('error', 'Gagal memuat data dropdown.');
            } finally {
                showGlobalStatus(false);
            }
        }

        function populateDropdowns() {
            const el = document.getElementById('absensi-ket');
            if (el && dbDropdown.keterangan) {
                el.innerHTML = '<option value="">-- Pilih Keterangan --</option>';
                dbDropdown.keterangan.forEach(val => el.add(new Option(val, val)));
            }
        }

        // FUNGSI SUBMIT DATA
        async function submitAbsensi() {
            const ket = document.getElementById('absensi-ket').value;
            const photoData = document.getElementById('absensi-photo-data').value;
            const btn = document.getElementById('btn-submit-absensi');

            if (!ket) return showNotify('error', 'Pilih keterangan kehadiran!');
            if (!photoData) return showNotify('error', 'Ambil foto terlebih dahulu!');

            btn.disabled = true;
            btn.innerText = "Mengirim...";
            showGlobalStatus(true);

            try {
                // Mengirim data menggunakan POST ke Apps Script
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submit_absensi',
                        email: currentUser.email,
                        nama: currentUser.nama,
                        syuqoh: currentUser.syuqoh,
                        keterangan: ket,
                        foto: photoData // Base64 foto
                    })
                });

                const result = await res.json();
                
                if (result.status === 'success') {
                    showNotify('success', 'Data absensi berhasil disimpan');
                    resetAbsensiForm();
                } else {
                    throw new Error(result.message || 'Gagal menyimpan');
                }
            } catch (e) {
                console.error(e);
                showNotify('error', 'Gagal simpan: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Simpan & Reset";
                showGlobalStatus(false);
            }
        }

        function resetAbsensiForm() {
            document.getElementById('absensi-ket').value = "";
            document.getElementById('absensi-photo-data').value = "";
            document.getElementById('photo-preview-absensi').classList.add('hidden');
            document.getElementById('photo-preview-absensi').src = "";
            document.getElementById('cam-placeholder-absensi').classList.remove('hidden');
            document.getElementById('video-absensi').classList.add('hidden');
            
            // Matikan kamera jika masih nyala
            const video = document.getElementById('video-absensi');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
            }
        }

        function startCamera(vId, pId) {
            const video = document.getElementById(vId);
            document.getElementById(pId).classList.add('hidden');
            video.classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => { video.srcObject = s; video.play(); })
                .catch(e => showNotify('error', "Kamera error: " + e));
        }

        function capturePhoto(vId, prId, dId) {
            const video = document.getElementById(vId);
            if (!video.srcObject) return showNotify('error', 'Buka kamera dulu!');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const data = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById(dId).value = data;
            
            const preview = document.getElementById(prId);
            preview.src = data; 
            preview.classList.remove('hidden');
            video.classList.add('hidden');
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const target = document.getElementById(`tab-${tabId}`);
            if (target) target.classList.add('active');
            btn.classList.add('active');
            document.getElementById('header-title').innerText = tabId.toUpperCase();
        }

        function showGlobalStatus(show) { document.getElementById('global-status').classList.toggle('hidden', !show); }
        
        function showNotify(type, msg) {
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = `p-4 rounded-xl shadow-xl text-white font-bold text-sm transform transition-all animate-bounce ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`;
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }
    </script>
</body>
</html>
