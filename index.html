<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pondok - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8">
            <div class="w-20 h-20 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="w-10 h-10 text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">Monitoring Pondok</h1>
            <p class="text-gray-500 mt-2">Silakan login menggunakan akun Google Ustadz</p>
        </div>
        <div id="google-btn-container"></div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="flex flex-col md:flex-row h-screen overflow-hidden blur-sm pointer-events-none transition-all duration-500">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg text-white">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">PondokApp</span>
            </div>

            <div class="p-4 border-b border-gray-50 bg-gray-50/50">
                <div class="flex items-center gap-3">
                    <img id="user-photo" src="" alt="Avatar" class="w-10 h-10 rounded-full border border-blue-200 hidden">
                    <div class="overflow-hidden">
                        <p id="user-name" class="font-bold text-sm truncate">Memuat...</p>
                        <p id="user-role" class="text-xs text-blue-600 font-medium truncate italic uppercase">Ustadz</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="switchTab('absensi', this)" class="nav-btn active w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="user-check" class="w-5 h-5 mr-3"></i> Absensi
                </button>
                <button onclick="switchTab('konseling', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="heart-handshake" class="w-5 h-5 mr-3"></i> Konseling
                </button>
                <button onclick="switchTab('pengawasan', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="shield" class="w-5 h-5 mr-3"></i> Pengawasan
                </button>
                <button onclick="switchTab('daur', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Laporan Daur
                </button>
                <button onclick="switchTab('terlambat', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100">
                    <i data-lucide="clock" class="w-5 h-5 mr-3"></i> Terlambat
                </button>
                <button onclick="switchTab('pelanggaran', this)" class="nav-btn w-full flex items-center p-3 rounded-xl transition-all duration-200 text-sm font-medium hover:bg-gray-100 text-red-600 hover:text-red-700">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-3"></i> Pelanggaran
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button onclick="location.reload()" class="w-full flex items-center p-3 rounded-xl text-gray-500 hover:bg-red-50 hover:text-red-600 transition-all text-sm font-medium">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Keluar
                </button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-10">
                <h2 id="header-title" class="font-bold text-lg text-gray-900">Absensi Kehadiran</h2>
                <div id="global-status" class="hidden flex items-center gap-2 text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full">
                    <div class="loader"></div> Sinkronisasi...
                </div>
            </header>

            <div class="p-4 md:p-8 max-w-4xl mx-auto">
                
                <!-- Tab Absensi -->
                <section id="tab-absensi" class="tab-content active space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Keterangan Kehadiran</label>
                        <select id="absensi-ket" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Pilih Keterangan --</option>
                        </select>
                        <div class="space-y-4">
                            <div class="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center border-2 border-dashed border-gray-300 relative">
                                <video id="video-absensi" class="hidden w-full h-full object-cover"></video>
                                <img id="photo-preview-absensi" class="hidden w-full h-full object-cover">
                                <div id="cam-placeholder-absensi" class="text-center">
                                    <i data-lucide="camera" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500">Klik "Buka Kamera"</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="startCamera('video-absensi', 'cam-placeholder-absensi')" class="flex-1 bg-gray-800 text-white py-3 rounded-xl text-sm font-bold">Buka Kamera</button>
                                <button onclick="capturePhoto('video-absensi', 'photo-preview-absensi', 'absensi-photo-data')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl text-sm font-bold">Ambil Foto</button>
                            </div>
                            <input type="hidden" id="absensi-photo-data">
                        </div>
                        <button onclick="submitAbsensi()" class="w-full mt-6 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition-all">Simpan & Reset</button>
                    </div>
                </section>

                <!-- Tab Konseling -->
                <section id="tab-konseling" class="tab-content space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Kamar</label>
                                <select id="konseling-kamar" onchange="filterSantriByKamar('konseling-santri')" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Santri & NISN</label>
                                <select id="konseling-santri" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none"></select>
                            </div>
                        </div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Laporan Konseling</label>
                        <textarea id="konseling-laporan" rows="5" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none mb-4" placeholder="Tulis rincian konseling di sini..."></textarea>
                        <button onclick="submitKonseling()" class="w-full bg-pink-600 text-white py-4 rounded-xl font-bold active:scale-[0.98] transition-all">Simpan Laporan</button>
                    </div>
                </section>

                <!-- Tab Pengawasan -->
                <section id="tab-pengawasan" class="tab-content space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Daur</label>
                        <select id="pengawasan-daur" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-6 outline-none"></select>
                        
                        <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4"></i> List Musyrif Gedung
                        </h3>
                        <div id="list-musyrif-pengawasan" class="space-y-3 mb-6">
                            <!-- Musyrif filter by gedung will appear here -->
                        </div>
                        <button onclick="submitPengawasan()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold active:scale-[0.98] transition-all">Simpan Pengawasan</button>
                    </div>
                </section>

                <!-- Tab Daur -->
                <section id="tab-daur" class="tab-content space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-900">Checklist Santri (Syuqoh)</h3>
                            <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-md font-bold" id="syuqoh-badge"></span>
                        </div>
                        <div id="list-daur-checklist" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                            <!-- Checklist santri -->
                        </div>
                        <div id="daur-selected-area" class="hidden space-y-4 pt-4 border-t border-gray-100">
                            <h4 class="font-bold text-sm text-gray-500 uppercase tracking-wider">Berikan Keterangan:</h4>
                            <div id="daur-inputs-container" class="space-y-3"></div>
                        </div>
                        <button onclick="submitDaur()" class="w-full mt-6 bg-emerald-600 text-white py-4 rounded-xl font-bold active:scale-[0.98] transition-all">Simpan & Reset</button>
                    </div>
                </section>

                <!-- Tab Terlambat -->
                <section id="tab-terlambat" class="tab-content space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Jenis Keterlambatan</label>
                                <select id="terlambat-jenis" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Gedung</label>
                                <select id="terlambat-gedung" onchange="clearSearch('terlambat')" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                                    <option value="">-- Pilih Gedung --</option>
                                    <option value="A">Gedung A</option>
                                    <option value="B">Gedung B</option>
                                    <option value="C">Gedung C</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="relative mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Cari Santri</label>
                            <input type="text" oninput="handleSearch(this.value, 'terlambat')" placeholder="Ketik minimal 3 huruf nama santri..." class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                            <div id="search-results-terlambat" class="absolute z-20 w-full bg-white shadow-xl rounded-xl mt-1 border border-gray-100 overflow-hidden hidden"></div>
                        </div>

                        <div id="terlambat-list-final" class="space-y-2 mb-6">
                            <!-- List santri yang ditambahkan -->
                        </div>
                        
                        <button onclick="submitTerlambat()" class="w-full bg-orange-500 text-white py-4 rounded-xl font-bold active:scale-[0.98] transition-all">Simpan Data</button>
                    </div>
                </section>

                <!-- Tab Pelanggaran -->
                <section id="tab-pelanggaran" class="tab-content space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Keterangan Pelanggaran</label>
                        <select id="pelanggaran-ket" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-4 outline-none"></select>
                        
                        <div class="relative mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Cari Santri</label>
                            <input type="text" oninput="handleSearch(this.value, 'pelanggaran')" placeholder="Ketik nama santri..." class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                            <div id="search-results-pelanggaran" class="absolute z-20 w-full bg-white shadow-xl rounded-xl mt-1 border border-gray-100 overflow-hidden hidden"></div>
                        </div>

                        <div id="pelanggaran-list-final" class="space-y-2 mb-6"></div>

                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6 text-center">
                            <img id="photo-preview-pelanggaran" class="hidden w-full max-w-xs mx-auto rounded-lg mb-4 shadow-md">
                            <div id="cam-area-pelanggaran" class="hidden flex flex-col items-center">
                                <video id="video-pelanggaran" class="w-full max-w-xs rounded-lg mb-4"></video>
                                <button onclick="capturePhoto('video-pelanggaran', 'photo-preview-pelanggaran', 'pelanggaran-photo-data')" class="bg-gray-800 text-white px-6 py-2 rounded-lg font-bold">Ambil Foto</button>
                            </div>
                            <button id="btn-open-cam-pel" onclick="startCamera('video-pelanggaran', 'btn-open-cam-pel', 'cam-area-pelanggaran')" class="flex items-center gap-2 mx-auto text-blue-600 font-bold">
                                <i data-lucide="camera" class="w-5 h-5"></i> Buka Kamera (Wajib Foto)
                            </button>
                            <input type="hidden" id="pelanggaran-photo-data">
                        </div>

                        <button onclick="submitPelanggaran()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold active:scale-[0.98] transition-all">Simpan Pelanggaran</button>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-6 right-6 z-[110] space-y-3 pointer-events-none"></div>

    <script>
        // --- KONFIGURASI ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzSS0nSmgz2zfi3sPJQaLge8cFkUWmpmmJAmXkWADKtzw--acOJnISWCFxsmWm8a4aF7w/exec";
        const CLIENT_ID = "142276774829-q7b6vicbq1hm1ltng7itehietn03l119.apps.googleusercontent.com"; // Sesuaikan jika berbeda

        let currentUser = null;
        let dbDropdown = {};
        let allSantriCache = []; // Untuk filter syuqoh
        let selectedItems = { terlambat: [], pelanggaran: [], daur: [] };

        window.onload = () => {
            initGoogleAuth();
            lucide.createIcons();
        };

        // --- AUTH LOGIC ---
        function initGoogleAuth() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("google-btn-container"),
                { theme: "outline", size: "large", shape: "pill" }
            );
        }

        async function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            showGlobalStatus(true);
            
            try {
                const res = await fetch(`${API_URL}?action=get_profile&email=${payload.email}`);
                const profile = await res.json();
                
                if (profile && profile.status !== "error") {
                    currentUser = { ...payload, ...profile };
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('blur-sm', 'pointer-events-none');
                    setupUserUI();
                    loadInitialData();
                } else {
                    alert("Akses Ditolak: Email Anda tidak ditemukan di DB USTADZ.");
                }
            } catch (e) {
                alert("Gagal terhubung ke Server.");
            } finally {
                showGlobalStatus(false);
            }
        }

        function setupUserUI() {
            document.getElementById('user-name').innerText = currentUser.nama;
            document.getElementById('user-photo').src = currentUser.picture;
            document.getElementById('user-photo').classList.remove('hidden');
            document.getElementById('syuqoh-badge').innerText = `Syuqoh: ${currentUser.syuqoh}`;
        }

        async function loadInitialData() {
            showGlobalStatus(true);
            try {
                // Ambil dropdown
                const resD = await fetch(`${API_URL}?action=get_initial_data`);
                dbDropdown = await resD.json();
                populateDropdowns();

                // Ambil santri khusus syuqoh user
                const resS = await fetch(`${API_URL}?action=get_santri_by_room&syuqoh=${currentUser.syuqoh}`);
                allSantriCache = await resS.json();
            } catch (e) {
                console.error("Load Data Error", e);
            } finally {
                showGlobalStatus(false);
            }
        }

        function populateDropdowns() {
            const populate = (id, arr) => {
                const el = document.getElementById(id);
                if (el) {
                    arr.forEach(val => el.add(new Option(val, val)));
                }
            };
            populate('absensi-ket', dbDropdown.keterangan || []);
            populate('pengawasan-daur', dbDropdown.daur || []);
            populate('terlambat-jenis', dbDropdown.jenisKeterlambatan || []);
            populate('pelanggaran-ket', dbDropdown.pelanggaran || []);
        }

        // --- UI LOGIC ---
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.add('active');
            btn.classList.add('active');
            
            const titles = {
                absensi: 'Absensi Kehadiran',
                konseling: 'Laporan Konseling',
                pengawasan: 'Pengawasan Daur',
                daur: 'Laporan Daur Harian',
                terlambat: 'Input Keterlambatan',
                pelanggaran: 'Input Pelanggaran'
            };
            document.getElementById('header-title').innerText = titles[tabId];

            if (tabId === 'konseling') prepareKonseling();
            if (tabId === 'daur') prepareDaur();
            if (tabId === 'pengawasan') preparePengawasan();
        }

        // --- FEATURE LOGIC: KONSELING ---
        function prepareKonseling() {
            const kamarSelect = document.getElementById('konseling-kamar');
            kamarSelect.innerHTML = '<option value="">-- Pilih Kamar --</option>';
            const kamars = [...new Set(allSantriCache.map(s => s.kamar))];
            kamars.sort().forEach(k => kamarSelect.add(new Option(`Kamar ${k}`, k)));
        }

        function filterSantriByKamar(targetId) {
            const kmr = document.getElementById('konseling-kamar').value;
            const select = document.getElementById(targetId);
            select.innerHTML = '<option value="">-- Pilih Santri --</option>';
            allSantriCache.filter(s => s.kamar == kmr).forEach(s => {
                select.add(new Option(`${s.nisn} - ${s.nama}`, s.nisn));
            });
        }

        // --- FEATURE LOGIC: PENGAWASAN ---
        async function preparePengawasan() {
            const list = document.getElementById('list-musyrif-pengawasan');
            list.innerHTML = '<p class="text-xs text-gray-400">Sedang memuat musyrif...</p>';
            try {
                const res = await fetch(`${API_URL}?action=get_musyrif_by_gedung&gedung=${currentUser.gedung}`);
                const musyrifs = await res.json();
                list.innerHTML = musyrifs.map(m => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <span class="text-sm font-bold">${m.nama} <span class="text-xs text-gray-400 font-normal">(${m.id})</span></span>
                        <select class="musyrif-status p-1 bg-white border rounded text-xs outline-none" data-id="${m.id}" data-nama="${m.nama}">
                            ${dbDropdown.keterangan.map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                `).join('');
            } catch (e) { list.innerHTML = 'Gagal memuat musyrif.'; }
        }

        // --- FEATURE LOGIC: DAUR ---
        function prepareDaur() {
            const container = document.getElementById('list-daur-checklist');
            allSantriCache.sort((a,b) => a.kamar - b.kamar);
            container.innerHTML = allSantriCache.map(s => `
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-emerald-50 transition-colors border border-transparent hover:border-emerald-200">
                    <input type="checkbox" class="daur-check-item w-5 h-5 rounded" value="${s.nisn}" data-nama="${s.nama}" data-kamar="${s.kamar}" onchange="updateDaurInputs()">
                    <div>
                        <p class="text-sm font-bold leading-tight">${s.nama}</p>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wide">Kamar ${s.kamar}</p>
                    </div>
                </label>
            `).join('');
        }

        function updateDaurInputs() {
            const chks = document.querySelectorAll('.daur-check-item:checked');
            const area = document.getElementById('daur-selected-area');
            const container = document.getElementById('daur-inputs-container');
            
            if (chks.length > 0) {
                area.classList.remove('hidden');
                container.innerHTML = Array.from(chks).map(c => `
                    <div class="flex items-center justify-between gap-3 p-3 bg-white border border-gray-100 rounded-xl shadow-sm">
                        <span class="text-xs font-bold truncate">${c.getAttribute('data-nama')}</span>
                        <select class="daur-ket-input p-2 bg-gray-50 border-none rounded-lg text-xs" data-nisn="${c.value}" data-nama="${c.getAttribute('data-nama')}" data-kamar="${c.getAttribute('data-kamar')}">
                             ${dbDropdown.keterangan.map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                `).join('');
            } else {
                area.classList.add('hidden');
            }
        }

        // --- CAMERA LOGIC ---
        function startCamera(videoId, btnId, areaId = null) {
            const video = document.getElementById(videoId);
            if (areaId) document.getElementById(areaId).classList.remove('hidden');
            document.getElementById(btnId).classList.add('hidden');
            video.classList.remove('hidden');

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => { video.srcObject = stream; video.play(); })
                .catch(err => alert("Gagal akses kamera: " + err));
        }

        function capturePhoto(videoId, previewId, dataId) {
            const video = document.getElementById(videoId);
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const data = canvas.toDataURL('image/jpeg', 0.7);
            document.getElementById(dataId).value = data;
            
            const preview = document.getElementById(previewId);
            preview.src = data;
            preview.classList.remove('hidden');
            video.classList.add('hidden');
            
            // Stop stream
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            showNotify('success', 'Foto berhasil diambil');
        }

        // --- SEARCH LOGIC (Terlambat & Pelanggaran) ---
        async function handleSearch(q, type) {
            const resultsBox = document.getElementById(`search-results-${type}`);
            if (q.length < 3) { resultsBox.classList.add('hidden'); return; }

            const gedung = type === 'terlambat' ? document.getElementById('terlambat-gedung').value : '';
            let url = `${API_URL}?action=search_santri&q=${q}`;
            if (gedung) url += `&gedung=${gedung}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length > 0) {
                    resultsBox.classList.remove('hidden');
                    resultsBox.innerHTML = data.map(s => `
                        <div onclick="addItem('${type}', '${s.nisn}', '${s.nama}', '${s.gedung}')" class="p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-sm">${s.nama}</p>
                                <p class="text-xs text-gray-400">${s.nisn} â€¢ ${s.gedung}</p>
                            </div>
                            <i data-lucide="plus-circle" class="w-5 h-5 text-blue-600"></i>
                        </div>
                    `).join('');
                    lucide.createIcons();
                } else {
                    resultsBox.innerHTML = '<p class="p-4 text-xs text-gray-400">Tidak ditemukan</p>';
                }
            } catch (e) {}
        }

        function addItem(type, nisn, nama, gedung) {
            if (selectedItems[type].find(i => i.nisn === nisn)) return;
            selectedItems[type].push({ nisn, nama, gedung });
            renderFinalList(type);
            document.getElementById(`search-results-${type}`).classList.add('hidden');
        }

        function renderFinalList(type) {
            const container = document.getElementById(`${type}-list-final`);
            container.innerHTML = selectedItems[type].map(i => `
                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-100 rounded-xl">
                    <span class="text-sm font-bold">${i.nama}</span>
                    <button onclick="removeItem('${type}', '${i.nisn}')" class="text-red-500"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function removeItem(type, nisn) {
            selectedItems[type] = selectedItems[type].filter(i => i.nisn !== nisn);
            renderFinalList(type);
        }

        // --- SUBMISSION LOGIC ---
        async function sendData(sheet, rows) {
            showGlobalStatus(true);
            const payload = {
                action: 'save_data',
                sheet: sheet,
                email: currentUser.email,
                nama_ustadz: currentUser.nama,
                rows: rows
            };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showNotify('success', 'Data Berhasil Terkirim!');
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (e) {
                showNotify('error', 'Gagal kirim data.');
            } finally {
                showGlobalStatus(false);
            }
        }

        async function submitAbsensi() {
            const ket = document.getElementById('absensi-ket').value;
            const photo = document.getElementById('absensi-photo-data').value;
            if (!ket) return alert("Pilih keterangan!");
            
            showGlobalStatus(true);
            const loc = await new Promise(r => navigator.geolocation.getCurrentPosition(p => r(`${p.coords.latitude},${p.coords.longitude}`), () => r("No GPS")));
            sendData('KEHADIRAN USTADZ', [[ket, photo, loc]]);
        }

        function submitKonseling() {
            const nisn = document.getElementById('konseling-santri').value;
            const nama = document.getElementById('konseling-santri').options[document.getElementById('konseling-santri').selectedIndex]?.text.split(' - ')[1];
            const kamar = document.getElementById('konseling-kamar').value;
            const laporan = document.getElementById('konseling-laporan').value;
            if (!nisn || !laporan) return alert("Lengkapi data!");
            
            sendData('KONSELING', [[currentUser.syuqoh, kamar, nisn, nama, laporan]]);
        }

        function submitPengawasan() {
            const daur = document.getElementById('pengawasan-daur').value;
            const rows = Array.from(document.querySelectorAll('.musyrif-status')).map(s => [
                currentUser.gedung, 
                daur, 
                s.getAttribute('data-id'), 
                s.getAttribute('data-nama'), 
                s.value
            ]);
            sendData('PENGAWAS DAUR', rows);
        }

        function submitDaur() {
            const rows = Array.from(document.querySelectorAll('.daur-ket-input')).map(s => [
                currentUser.syuqoh,
                s.getAttribute('data-nisn'),
                s.getAttribute('data-nama'),
                s.getAttribute('data-kamar'),
                s.value
            ]);
            if (rows.length === 0) return alert("Pilih santri!");
            sendData('LAPORAN DAUR', rows);
        }

        function submitTerlambat() {
            const jenis = document.getElementById('terlambat-jenis').value;
            const gedung = document.getElementById('terlambat-gedung').value;
            const rows = selectedItems.terlambat.map(i => [jenis, i.gedung || gedung, i.nisn, i.nama]);
            if (rows.length === 0) return alert("Pilih santri!");
            sendData('KETERLAMBATAN SANTRI', rows);
        }

        function submitPelanggaran() {
            const ket = document.getElementById('pelanggaran-ket').value;
            const photo = document.getElementById('pelanggaran-photo-data').value;
            const rows = selectedItems.pelanggaran.map(i => [photo, i.gedung, i.nisn, i.nama, ket]);
            if (rows.length === 0 || !photo) return alert("Pilih santri dan ambil foto!");
            sendData('PELANGGARAN', rows);
        }

        // --- HELPERS ---
        function showGlobalStatus(show) { document.getElementById('global-status').classList.toggle('hidden', !show); }
        function showNotify(type, msg) {
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = `p-4 rounded-2xl shadow-2xl text-white font-bold text-sm transform transition-all animate-bounce ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`;
            el.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${type === 'success' ? 'check-circle' : 'x-circle'}"></i> ${msg}</div>`;
            container.appendChild(el);
            lucide.createIcons();
            setTimeout(() => el.remove(), 4000);
        }
    </script>
</body>
</html>
